<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Foody — Витрина</title>
  <link rel="icon" href="/web/favicon.png"/>
  <script src="/config.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#f7f7f9;margin:0;color:#111}
    header{display:flex;gap:8px;align-items:center;padding:14px 16px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    header img{height:24px}
    .wrap{max-width:980px;margin:16px auto;padding:0 16px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    select,button{font:inherit;padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .title{font-weight:700;margin:6px 0}
    .muted{color:#666;font-size:12px}
    .price{font-size:18px;font-weight:700;margin:8px 0}
    .btn{background:#111;color:#fff;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
    #toast{position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;display:none}
  </style>
</head>
<body>
<header>
  <img src="/web/logo.png"/><b>Foody — Витрина</b>
  <a href="/web/merchant/" style="margin-left:auto">ЛК партнёра →</a>
</header>
<div class="wrap">
  <div class="controls">
    <select id="sort">
      <option value="new">Сначала новинки</option>
      <option value="price">Сначала дешевле</option>
      <option value="distance">Ближе ко мне</option>
    </select>
    <select id="radius">
      <option value="">Без радиуса</option>
      <option value="2">2 км</option>
      <option value="5">5 км</option>
      <option value="10">10 км</option>
    </select>
    <button class="btn" id="btnGeo">Определить гео</button>
  </div>
  <div class="grid" id="grid"></div>
</div>

<div id="toast"></div>

<script>
const API = window.FOODY_API || '';
function toast(s){ const t=document.getElementById('toast'); t.textContent=s; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
let GEO = {lat:null, lon:null};

document.getElementById('btnGeo').onclick=()=>{
  if(!navigator.geolocation) return toast('Гео недоступно');
  navigator.geolocation.getCurrentPosition(p=>{
    GEO.lat = p.coords.latitude; GEO.lon = p.coords.longitude;
    toast('Гео определено'); load();
  }, ()=> toast('Нет доступа к гео'));
};

async function load(){
  const sort = document.getElementById('sort').value;
  const radius = document.getElementById('radius').value;
  const qs = new URLSearchParams();
  qs.set('sort', sort);
  if (GEO.lat && GEO.lon) { qs.set('lat', GEO.lat); qs.set('lon', GEO.lon); }
  if (radius) qs.set('radius_km', radius);
  try{
    const rs = await fetch(API + '/api/v1/offers?' + qs.toString());
    const arr = await rs.json();
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    if (!Array.isArray(arr) || arr.length===0) {
      grid.innerHTML = '<div class="muted">Пока пусто. Попробуйте позже.</div>';
      return;
    }
    for (const o of arr){
      const eff = (o.effective_price_cents ?? o.price_cents) / 100;
      const orig = (o.original_price_cents || 0) / 100;
      const disc = o.discount_step ? ` −${o.discount_step}%` : '';
      const km = (o.distance_km!=null) ? ` • ${(o.distance_km).toFixed(1)} км` : '';
      const left = `Осталось: ${o.qty_left}`;
      const exp = o.expires_at ? new Date(o.expires_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '—';
      const img = o.photo_url ? `<img src="${o.photo_url}" style="width:100%;height:150px;object-fit:cover;border-radius:8px"/>` : '';
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `${img}<div class="title">${o.title}</div>
        <div class="muted">${o.restaurant.title} • ${o.restaurant.address || ''}${km}</div>
        <div class="price">${eff.toFixed(2)} ₽ <span class="muted">${disc}</span></div>
        <div class="muted">До: ${exp} • ${left}</div>
        <button class="btn">Забронировать</button>`;
      el.querySelector('.btn').onclick = ()=> reserve(o.id);
      grid.appendChild(el);
    }
  }catch(e){
    toast('Ошибка загрузки');
    console.error(e);
  }
}
async function reserve(offer_id){
  const qty = Number(prompt('Сколько штук?','1'))||1;
  try{
    const rs = await fetch(API + '/api/v1/reservations', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({offer_id, qty})});
    const j = await rs.json();
    if(!rs.ok){ throw new Error(j.detail || 'Ошибка'); }
    const img = new Image();
    img.src = 'data:image/png;base64,' + j.qrcode_png_base64;
    const w = window.open('','_blank');
    w.document.write('<h3>Ваш QR</h3>');
    w.document.body.appendChild(img);
  }catch(e){ toast(e.message); }
}

document.getElementById('sort').onchange = load;
document.getElementById('radius').onchange = load;

load();
</script>
</body>
</html>
